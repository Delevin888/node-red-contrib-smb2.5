<!--
Copyright 2018 Smart-Tech Controle e Automação
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<script type="text/x-red" data-template-name="SMB">

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="smb.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]smb.label.name">
    </div>

    <div class="form-row">
        <label for="node-input-config">
            <i class="fa fa-cog"></i>
            <span data-i18n="smb.label.config"></span>
        </label>
        <input type="text" id="node-input-config" data-i18n="[placeholder]smb.label.config">
    </div>

    <div class="form-row">
        <label for="node-input-operation">
            <i class="fa fa-bars"></i>
            <span data-i18n="smb.label.operation"></span>
        </label>
        <select type="text" id="node-input-operation">
            <option value="read-dir" data-i18n="smb.operation.read-dir"> </option>
            <option value="read-file" data-i18n="smb.operation.read-file"> </option>
            <option value="unlink" data-i18n="smb.operation.unlink"> </option>
            <option value="rename" data-i18n="smb.operation.rename"> </option>
            <option value="create" data-i18n="smb.operation.create"> </option>
            <option value="mkdir" data-i18n="smb.operation.mkdir"> </option>
            <option value="rmdir" data-i18n="smb.operation.rmdir"> </option>
            <option value="exists" data-i18n="smb.operation.exists"> </option>
            <option value="ensure-dir" data-i18n="smb.operation.ensure-dir"> </option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-path">
            <i class="fa fa-folder-open"></i>
            <span data-i18n="smb.label.path"></span>
        </label>
        <input type="text" id="node-input-path" data-i18n="[placeholder]smb.label.path">
    </div>

    <div class="form-row" id="new-path">
        <label for="node-input-path_new">
            <i class="fa fa-folder-open"></i>
            <span data-i18n="smb.label.path-new"></span>
        </label>
        <input type="text" id="node-input-path_new" data-i18n="[placeholder]smb.label.path-new">
    </div>

    <div class="form-row" id="smb-output-format">
        <label for="node-input-format">
            <i class="fa fa-sign-out"></i>
            <span data-i18n="smb.label.format"></span>
        </label>
        <select type="text" id="node-input-format">
            <option value="string" data-i18n="smb.format.string"></option>
            <option value="binary" data-i18n="smb.format.binary"></option>
        </select>
    </div>

</script>

<script type="text/x-red" data-help-name="SMB">
    <p>
        <b>Node SMB Protocol</b>
    </p>

    <h3>Input</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">string</span>
        </dt>
        <dd>data for file.</dd>
    </dl>

    <dl class="message-properties">
        <dt>filename
            <span class="property-type">string</span>
        </dt>
        <dd>define path file for operations.</dd>
    </dl>

    <dl class="message-properties">
        <dt>new_filename
            <span class="property-type">string</span>
        </dt>
        <dd>define new path or file name for Move/Rename operation.</dd>
    </dl>


    <h3>Details</h3>
    <dl class="message-properties">
        <dt>config
            <span class="property-type">SMB Config</span>
        </dt>
        <dd>the path to operate on.</dd>
    </dl>


    <h3>Operations</h3>
    <dl class="message-properties">
        <dt>Read directory</dt>
        <dd>this operation return an array of file object.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Read file</dt>
        <dd>
            this operation return a string with content of file.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Remove file</dt>
        <dd>
            this operation remove file.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Rename/Move file</dt>
        <dd>
            this operation move or rename file.
            <br> If not set
            <code>Path</code> or
            <code>New path</code> in node properties, then
            <code>msg.filename</code> is used as Path and
            <code>msg.new_filename</code> is used as New Path.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Create file</dt>
        <dd>
            this operation create new file.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path and
            <code>msg.payload</code> is content of file.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>MKDIR</dt>
        <dd>
            this operation create new directory.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path for new directory.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>RMDIR</dt>
        <dd>
            this operation remove directory.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path for remove directory.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Exists</dt>
        <dd>
            this operation test if exist a file.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path for test.
            <br>Output: <code>msg.exists</code>.
        </dd>
    </dl>

    <dl class="message-properties">
        <dt>Ensure dir</dt>
        <dd>
            this operation tests if the directory exist, if not, this operation will create it.
            <br> If not set
            <code>Path</code> in node properties, then
            <code>msg.filename</code> is used as Path.
        </dd>
    </dl>

</script>

<script type="text/javascript">
    RED.nodes.registerType('SMB', {
        category: 'storage',
        color: '#DEB887',
        defaults: {
            name: {
                value: ""
            },
            config: {
                value: "",
                type: "smb config"
            },
            operation: {
                value: "read-dir"
            },
            path: {
                value: ""
            },
            path_new: {
                value: ""
            },
            format: {
                value: "string"
            }

        },
        inputs: 1,
        outputs: 1,
        icon: "file.png",
        paletteLabel: "smb",
        label: function () {

            if (this.name) {
                return this.name;
            }

            var selectConfig = RED.nodes.node(this.config);

            if (selectConfig) {

                let operation = "";

                switch (this.operation) {
                    case "read-dir":
                        operation = "Read dir";
                        break;

                    case "read-file":
                        operation = "Read file";
                        break;

                    case "rename":
                        operation = "Rename/Move";
                        break;

                    case "unlink":
                        operation = "Remove";
                        break;

                    case "create":
                        operation = "Create";
                        break;

                    case "mkdir":
                        operation = "MKDIR";
                        break;

                    case "rmdir":
                        operation = "RMDIR";
                        break;

                    case "exists":
                        operation = "Exists";
                        break;

                    case "ensure-dir":
                        operation = "Ensure Dir";
                        break;
                }

                return selectConfig.label() + " : " + operation;
            }

        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {

            let new_path = $("#new-path");
            let format = $("#smb-output-format");
            let operation_select = $("#node-input-operation");

            if (this.format === undefined) {
                this.format = "string";
            }

            function onOperationChange() {

                new_path.hide();
                format.hide();

                var operationVal = operation_select.val();

                if (operationVal == "rename") {
                    new_path.show();
                } else if (operationVal === "read-file") {
                    format.show();
                }
            }

            operation_select.change(onOperationChange);
            onOperationChange();
        }
    });
</script>



<!-- CONFIG -->

<script type="text/x-red" data-template-name="smb config">

    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>
            <span data-i18n="smb.label.name"></span>
        </label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]smb.label.name">
    </div>

    <div class="form-row">
        <label for="node-config-input-share">
            <i class="fa fa-sitemap"></i>
            <span data-i18n="smb.label.share"></span>
        </label>
        <input type="text" id="node-config-input-share" data-i18n="[placeholder]smb.label.share">
    </div>

    <div class="form-row">
        <label for="node-config-input-domain">
            <i class="fa fa-globe"></i>
            <span data-i18n="smb.label.domain"></span>
        </label>
        <input type="text" id="node-config-input-domain" data-i18n="[placeholder]smb.label.domain">
    </div>

    <div class="form-row">
        <label for="node-config-input-username">
            <i class="fa fa-user"></i>
            <span data-i18n="smb.label.username"></span>
        </label>
        <input type="text" id="node-config-input-username" data-i18n="[placeholder]smb.label.username">
    </div>

    <div class="form-row">
        <label for="node-config-input-password">
            <i class="fa fa-key"></i>
            <span data-i18n="smb.label.password"></span>
        </label>
        <input type="password" id="node-config-input-password" data-i18n="[placeholder]smb.label.password">
    </div>


</script>

<script type="text/x-red" data-help-name="smb config">
    <p>
        <b>Node SMB Protocol</b>
    </p>

    <h3>Details</h3>

    <dl class="message-properties">
        <dt>Share
            <span class="property-type">string</span>
        </dt>
        <dd>define the path sharing.</dd>
    </dl>

    <dl class="message-properties">
        <dt>Domain
            <span class="property-type">string</span>
        </dt>
        <dd>define the domain for authentication.</dd>
    </dl>

    <dl class="message-properties">
        <dt>Username
            <span class="property-type">string</span>
        </dt>
        <dd>define the username for authentication.</dd>
    </dl>

    <dl class="message-properties">
        <dt>Password
            <span class="property-type">string</span>
        </dt>
        <dd>define the password for authentication.</dd>
    </dl>
</script>

<script type="text/javascript">
    RED.nodes.registerType("smb config", {
        category: 'config',
        color: '#FFAAAA',
        defaults: {
            name: {
                value: ""
            },
            share: {
                value: ""
            },
            domain: {
                value: ""
            }
        },
        credentials: {
            username: {
                type: "text"
            },
            password: {
                type: "password"
            }
        },
        label: function () {
            return this.name || this.share;
        }
    });
</script>